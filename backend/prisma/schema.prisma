generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Driver {
  id              String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String                @db.VarChar(255)
  phone           String                @unique @db.VarChar(20)
  email           String                @unique @db.VarChar(255)
  status          String                @default("active") @db.VarChar(50)
  createdAt       DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime              @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  devices         Device[]
  driverDocuments DriverDocument[]
  driverProfile   DriverProfile?
  driverSettings  DriverSettings?
  driverStatuses  DriverStatusSnapshot?
  statusLogs      DriverStatusLog[]
  gpsLogs         GpsLog[]
  ordersAssigned  OrderAssignment[]
  routes          Route[]
  shifts          Shift[]
  zoneAssignments ZoneDriver[]

  @@index([status], map: "idx_drivers_status")
  @@index([createdAt(sort: Desc)], map: "idx_drivers_created")
  @@map("drivers")
}

model DriverStatusLog {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  driverId  String   @map("driver_id") @db.Uuid
  status    String   @db.VarChar(50)
  timestamp DateTime @default(now()) @db.Timestamptz(6)
  reason    String?  @db.VarChar(255)
  driver    Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([driverId], map: "idx_driver_status_logs_driver")
  @@index([timestamp(sort: Desc)], map: "idx_driver_status_logs_timestamp")
  @@map("driver_status_logs")
}

model GpsLog {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  driverId  String   @map("driver_id") @db.Uuid
  latitude  Decimal  @db.Decimal(10, 8)
  longitude Decimal  @db.Decimal(11, 8)
  speed     Float?
  accuracy  Float?
  timestamp DateTime @default(now()) @db.Timestamptz(6)
  driver    Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([driverId, timestamp(sort: Desc)], map: "idx_gps_logs_driver_time")
  @@index([timestamp(sort: Desc)], map: "idx_gps_logs_timestamp")
  @@map("gps_logs")
}

model Shift {
  id              String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  driverId        String       @map("driver_id") @db.Uuid
  startTime       DateTime     @map("start_time") @db.Timestamptz(6)
  endTime         DateTime?    @map("end_time") @db.Timestamptz(6)
  status          String       @default("active") @db.VarChar(50)
  ordersCompleted Int          @default(0) @map("orders_completed")
  distanceKm      Float?       @map("distance_km")
  createdAt       DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  events          ShiftEvent[]
  driver          Driver       @relation(fields: [driverId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([driverId], map: "idx_shifts_driver")
  @@index([status], map: "idx_shifts_status")
  @@index([createdAt(sort: Desc)], map: "idx_shifts_created")
  @@map("shifts")
}

model Device {
  id           String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  driverId     String?         @map("driver_id") @db.Uuid
  deviceType   String?         @map("device_type") @db.VarChar(50)
  model        String?         @db.VarChar(100)
  serialNumber String?         @unique @map("serial_number") @db.VarChar(255)
  pushToken    String?         @map("push_token") @db.VarChar(500)
  createdAt    DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  sessions     DeviceSession[]
  driver       Driver?         @relation(fields: [driverId], references: [id], onUpdate: NoAction)
  tokens       PushToken[]

  @@index([driverId], map: "idx_devices_driver")
  @@map("devices")
}

model DriverProfile {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  driverId         String    @unique @map("driver_id") @db.Uuid
  licenseNumber    String    @map("license_number") @db.VarChar(50)
  license_category String?   @db.VarChar(20)
  dateOfBirth      DateTime? @map("date_of_birth") @db.Date
  address          String?
  emergencyContact Json?     @map("emergency_contact")
  createdAt        DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)
  driver           Driver    @relation(fields: [driverId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("driver_profile")
}

model DriverSettings {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  driverId             String    @unique @map("driver_id") @db.Uuid
  preferred_shift      String?   @db.VarChar(50)
  notificationsEnabled Boolean?  @default(true) @map("notifications_enabled")
  language             String?   @default("ru") @db.VarChar(5)
  createdAt            DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)
  driver               Driver    @relation(fields: [driverId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("driver_settings")
}

model DriverStatusSnapshot {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  driverId     String    @unique @map("driver_id") @db.Uuid
  availability String    @db.VarChar(50)
  last_online  DateTime? @db.Timestamptz(6)
  location     Json?
  driver       Driver    @relation(fields: [driverId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("driver_status")
}

model DriverDocument {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  driverId  String    @map("driver_id") @db.Uuid
  type      String    @db.VarChar(50)
  number    String?   @db.VarChar(100)
  issuedAt  DateTime? @map("issued_at") @db.Date
  expiresAt DateTime? @map("expires_at") @db.Date
  fileUrl   String?   @map("file_url")
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  driver    Driver    @relation(fields: [driverId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([driverId], map: "idx_driver_documents_driver")
  @@map("driver_documents")
}

model Zone {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String       @db.VarChar(255)
  color       String?      @db.VarChar(20)
  description String?
  createdAt   DateTime?    @default(now()) @map("created_at") @db.Timestamptz(6)
  orders      Order[]
  assignments ZoneDriver[]
  streets     ZoneStreet[]

  @@map("zones")
}

model ZoneStreet {
  id     String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  zoneId String @map("zone_id") @db.Uuid
  street String @db.VarChar(255)
  zone   Zone   @relation(fields: [zoneId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([zoneId], map: "idx_zone_streets_zone")
  @@map("zone_streets")
}

model ZoneDriver {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  zoneId     String    @map("zone_id") @db.Uuid
  driverId   String    @map("driver_id") @db.Uuid
  assignedAt DateTime? @default(now()) @map("assigned_at") @db.Timestamptz(6)
  driver     Driver    @relation(fields: [driverId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  zone       Zone      @relation(fields: [zoneId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([driverId], map: "idx_zone_driver_driver")
  @@index([zoneId], map: "idx_zone_driver_zone")
  @@map("zone_driver")
}

model Order {
  id           String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  externalId   String?            @map("external_id") @db.VarChar(100)
  customerName String?            @map("customer_name") @db.VarChar(255)
  status       String             @db.VarChar(50)
  zone_id      String?            @db.Uuid
  createdAt    DateTime?          @default(now()) @map("created_at") @db.Timestamptz(6)
  updated_at   DateTime?          @default(now()) @db.Timestamptz(6)
  signatures   CustomerSignature?
  assignments  OrderAssignment[]
  photos       OrderPhoto[]
  points       OrderPoint[]
  statusLogs   OrderStatusLog[]
  zones        Zone?              @relation(fields: [zone_id], references: [id], onUpdate: NoAction)
  routes       Route[]

  @@index([status], map: "idx_orders_status")
  @@map("orders")
}

model OrderPoint {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId   String    @map("order_id") @db.Uuid
  kind      String    @db.VarChar(20)
  address   String    @db.VarChar(255)
  latitude  Decimal?  @db.Decimal(10, 8)
  longitude Decimal?  @db.Decimal(11, 8)
  sequence  Int
  eta       DateTime? @db.Timestamptz(6)
  status    String?   @db.VarChar(50)
  order     Order     @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([orderId], map: "idx_order_points_order")
  @@map("order_points")
}

model OrderAssignment {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId    String    @map("order_id") @db.Uuid
  driverId   String    @map("driver_id") @db.Uuid
  status     String    @db.VarChar(50)
  assignedAt DateTime? @default(now()) @map("assigned_at") @db.Timestamptz(6)
  driver     Driver    @relation(fields: [driverId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  order      Order     @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([driverId], map: "idx_order_assignments_driver")
  @@index([orderId], map: "idx_order_assignments_order")
  @@map("order_assignments")
}

model OrderStatusLog {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId   String    @map("order_id") @db.Uuid
  status    String    @db.VarChar(50)
  note      String?
  timestamp DateTime? @default(now()) @db.Timestamptz(6)
  order     Order     @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([orderId], map: "idx_order_status_logs_order")
  @@map("order_status_logs")
}

model OrderPhoto {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId   String    @map("order_id") @db.Uuid
  photo_url String
  type      String?   @db.VarChar(50)
  taken_at  DateTime? @db.Timestamptz(6)
  order     Order     @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([orderId], map: "idx_order_photos_order")
  @@map("order_photos")
}

model CustomerSignature {
  id       String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId  String    @unique @map("order_id") @db.Uuid
  file_url String
  signedAt DateTime? @map("signed_at") @db.Timestamptz(6)
  order    Order     @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("customer_signatures")
}

model Route {
  id        String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId   String?      @map("order_id") @db.Uuid
  driver_id String?      @db.Uuid
  status    String       @db.VarChar(50)
  createdAt DateTime?    @default(now()) @map("created_at") @db.Timestamptz(6)
  logs      RouteLog[]
  points    RoutePoint[]
  drivers   Driver?      @relation(fields: [driver_id], references: [id], onUpdate: NoAction)
  order     Order?       @relation(fields: [orderId], references: [id], onUpdate: NoAction)

  @@map("routes")
}

model RoutePoint {
  id       String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  routeId  String    @map("route_id") @db.Uuid
  sequence Int
  address  String    @db.VarChar(255)
  status   String?   @db.VarChar(50)
  eta      DateTime? @db.Timestamptz(6)
  route    Route     @relation(fields: [routeId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([routeId], map: "idx_route_points_route")
  @@map("route_points")
}

model RouteLog {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  routeId   String    @map("route_id") @db.Uuid
  message   String
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  route     Route     @relation(fields: [routeId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([routeId], map: "idx_route_logs_route")
  @@map("route_logs")
}

model ShiftEvent {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shiftId   String    @map("shift_id") @db.Uuid
  eventType String    @map("event_type") @db.VarChar(50)
  payload   Json?
  timestamp DateTime? @default(now()) @db.Timestamptz(6)
  shift     Shift     @relation(fields: [shiftId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([shiftId], map: "idx_shift_events_shift")
  @@map("shift_events")
}

model DeviceSession {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  deviceId   String    @map("device_id") @db.Uuid
  startedAt  DateTime? @default(now()) @map("started_at") @db.Timestamptz(6)
  endedAt    DateTime? @map("ended_at") @db.Timestamptz(6)
  ip_address String?   @db.VarChar(100)
  device     Device    @relation(fields: [deviceId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([deviceId], map: "idx_device_sessions_device")
  @@map("device_sessions")
}

model PushToken {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  deviceId  String?   @map("device_id") @db.Uuid
  token     String
  platform  String?   @db.VarChar(20)
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  device    Device?   @relation(fields: [deviceId], references: [id], onUpdate: NoAction)

  @@index([deviceId], map: "idx_push_tokens_device")
  @@map("push_tokens")
}

model Alert {
  id        String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type      String        @db.VarChar(50)
  payload   Json?
  status    String        @db.VarChar(50)
  createdAt DateTime?     @default(now()) @map("created_at") @db.Timestamptz(6)
  actions   AlertAction[]

  @@map("alerts")
}

model AlertAction {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  alertId   String    @map("alert_id") @db.Uuid
  actor     String?   @db.VarChar(255)
  action    String    @db.VarChar(100)
  timestamp DateTime? @default(now()) @db.Timestamptz(6)
  alert     Alert     @relation(fields: [alertId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([alertId], map: "idx_alert_actions_alert")
  @@map("alert_actions")
}

model SystemLog {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  level     String    @db.VarChar(20)
  message   String
  context   Json?
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([level], map: "idx_system_logs_level")
  @@map("system_logs")
}

model ApiLog {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  method     String    @db.VarChar(10)
  path       String    @db.VarChar(255)
  status     Int
  latency_ms Int
  createdAt  DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  @@map("api_logs")
}

model AppError {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  source    String    @db.VarChar(50)
  message   String
  stack     String?
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  @@map("app_errors")
}
